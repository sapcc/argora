{{- if .Values.manager.enable }}
apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        app.kubernetes.io/component: argora-operator
        app.kubernetes.io/managed-by: {{ .Release.Service }}
        app.kubernetes.io/name: {{ include "argora.name" . }}
        helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/part-of: argora-operator
        control-plane: controller-manager
    name: {{ include "argora.resourceName" (dict "suffix" "controller-manager" "context" $) }}
    namespace: {{ .Release.Namespace }}
spec:
    replicas: 1
    selector:
        matchLabels:
            app.kubernetes.io/name: {{ include "argora.name" . }}
            control-plane: controller-manager
    template:
        metadata:
            annotations:
                kubectl.kubernetes.io/default-container: manager
            labels:
                app.kubernetes.io/component: argora-operator
                app.kubernetes.io/managed-by: {{ .Release.Service }}
                app.kubernetes.io/name: {{ include "argora.name" . }}
                helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
                app.kubernetes.io/instance: {{ .Release.Name }}
                app.kubernetes.io/part-of: argora-operator
                control-plane: controller-manager
                {{- range $key, $value := .Values.manager.podLabels }}
                {{ $key }}: {{ $value }}
                {{- end }}
        spec:
            {{- with .Values.manager.tolerations }}
            tolerations: {{ toYaml . | nindent 16 }}
            {{- end }}
            {{- with .Values.manager.affinity }}
            affinity: {{ toYaml . | nindent 16 }}
            {{- end }}
            {{- with .Values.manager.nodeSelector }}
            nodeSelector: {{ toYaml . | nindent 16 }}
            {{- end }}
            containers:
                - args:
                    {{- if .Values.metrics.enable }}
                    - --metrics-bind-address=:{{ .Values.metrics.port }}
                    {{- else }}
                    # Bind to :0 to disable the controller-runtime managed metrics server
                    - --metrics-bind-address=0
                    {{- end }}
                    - --health-probe-bind-address=:8081
                    - --enable-ironcore={{ .Values.ironcore.enable }}
                    - --netbox-url={{ .Values.netboxURL }}
                    {{- range .Values.manager.args }}
                    - {{ . }}
                    {{- end }}
                  command:
                    - /manager
                  image: "{{ .Values.manager.image.repository }}:{{ .Values.manager.image.tag }}"
                  imagePullPolicy: {{ .Values.manager.image.pullPolicy }}
                  livenessProbe:
                    httpGet:
                        path: /healthz
                        port: 8081
                    initialDelaySeconds: 15
                    periodSeconds: 20
                  name: manager
                  {{- if .Values.manager.env }}
                  env:
                    {{- range $key, $value := .Values.manager.env }}
                    - name: {{ $key }}
                      value: {{ $value | quote}}
                    {{- end }}
                  {{- end }}
                  ports: []
                  readinessProbe:
                    httpGet:
                        path: /readyz
                        port: 8081
                    initialDelaySeconds: 5
                    periodSeconds: 10
                  resources:
                    {{- if .Values.manager.resources }}
                    {{- toYaml .Values.manager.resources | nindent 20 }}
                    {{- else }}
                    {}
                    {{- end }}
                  securityContext:
                    {{- if .Values.manager.securityContext }}
                    {{- toYaml .Values.manager.securityContext | nindent 20 }}
                    {{- else }}
                    {}
                    {{- end }}
                  volumeMounts:
                    - mountPath: /etc/credentials
                      name: secret-volume
                      readOnly: true
                    {{- range $volume := .Values.manager.volumes }}
                    - mountPath: {{ $volume.mountPath }}
                      name: {{ $volume.name }}
                      {{- if $volume.readOnly }}
                      readOnly: true
                      {{- end }}
                    {{- end }}
            securityContext:
              {{- if .Values.manager.podSecurityContext }}
              {{- toYaml .Values.manager.podSecurityContext | nindent 14 }}
              {{- else }}
              {}
              {{- end }}
            serviceAccountName: {{ include "argora.resourceName" (dict "suffix" "controller-manager" "context" $) }}
            terminationGracePeriodSeconds: 10
            volumes:
                - name: secret-volume
                  secret:
                    secretName: {{ include "argora.resourceName" (dict "suffix" "secret" "context" $) }}
                {{- range $volume := .Values.manager.volumes }}
                - name: {{ $volume.name }}
                  {{- toYaml $volume.source | nindent 18 }}
                {{- end }}
{{- end }}
